来訪受付アプリ作成手順
===

<!-- TOC -->

- [1. Power Automate Cloud Flow Import](#1-power-automate-cloud-flow-import)
- [2. インポートしたフローの編集](#2-インポートしたフローの編集)
- [3. 受付アプリ の作成](#3-受付アプリ-の作成)
    - [3.1. 認証画面の作成](#31-認証画面の作成)
    - [3.2. 成功画面の作成](#32-成功画面の作成)
    - [3.3. 失敗画面の作成](#33-失敗画面の作成)

<!-- /TOC -->

# 1. Power Automate Cloud Flow Import

1.  [こちらのフローインポートファイル](./PowerAutomate/顔認証フローインポートファイル.zip) をダウンロードします。

2. Power Automate にアクセスします。

![](pasteimage/2021-08-18-11-07-02.png)

3. 開発者環境になっていることを確認します。

![](pasteimage/2021-08-18-11-07-56.png)

4. マイフローをクリックします。

![](pasteimage/2021-08-18-11-08-31.png)

5. インポートをクリックします。

![](pasteimage/2021-08-18-11-09-09.png)

6. アップロードをクリックします。

![](pasteimage/2021-08-18-11-11-04.png)

7. ダウンロードしたインポートファイルを選択します。

![](pasteimage/2021-08-18-11-14-29.png)

8. アップロードが行われるので終わるまで待ちます。

![](pasteimage/2021-08-18-11-15-09.png)

9. 関連リソースの選択がありますので、「インポート自に選択する」をそれぞれクリックし、Face API とストレージアカウントの接続情報を指定します。

![](pasteimage/2021-08-18-11-17-27.png)

![](pasteimage/2021-08-18-11-18-16.png)

※ない場合は、新規作成より認証情報をそれぞれ作成します。

![](pasteimage/2021-08-18-11-19-35.png)

![](pasteimage/2021-08-18-11-20-33.png)

Azure Blob Storage

![](pasteimage/2021-08-18-11-20-55.png)

Face API

![](pasteimage/2021-08-18-11-21-19.png)

10. 接続情報の指定が完了するとインポートが押せるようになるので、インポートします。

![](pasteimage/2021-08-18-11-22-43.png)


11. インポートが完了するとこのような表示になります

![](pasteimage/2021-08-18-11-23-32.png)


# 2. インポートしたフローの編集

1. マイフローを開くと、「顔認証フロー」が追加されています。

![](pasteimage/2021-08-18-12-00-40.png)

2. 「顔認証フロー」にカーソルを合わせ、編集ボタンをクリックします。

![](pasteimage/2021-08-18-12-01-55.png)

3. 「Var Face API URL」をクリックし、値に作成したFace API のURLを入力します。

![](pasteimage/2021-08-18-12-04-12.png)

URL は Face API のエンドポイントで取得できます。

![](pasteimage/2021-08-18-12-25-29.png)

4. 「Var Face API Key」をクリックし、値に作成したFace APIのアクセスキーを入力します。

![](pasteimage/2021-08-18-12-31-06.png)

5. 「BLOB を作成する（V2）」をクリックし、ストレージアカウント名とフォルダーパスをそれぞれ作成したものを指定します。

![](pasteimage/2021-08-18-12-33-35.png)

6. 「Get a Person Group」をクリックし、Person Group Id を作成したIDに切り替えます。

![](pasteimage/2021-08-18-12-36-14.png)

7. 「保存」をクリックします。

![](pasteimage/2021-08-18-12-37-16.png)

8. 前のページに戻ります。

![](pasteimage/2021-08-18-12-37-56.png)

9. 「オンにする」をクリックします。

![](pasteimage/2021-08-18-12-38-34.png)


# 3. 受付アプリ の作成

1. Power Apps を開きます。

![](pasteimage/2021-08-18-12-48-52.png)

2. キャンバスアプリを一から作成をクリックします。

![](pasteimage/2021-08-18-12-52-01.png)

3. 任意の名称にして、形式は「電話」にし、「作成」をクリックします。

![](pasteimage/2021-08-18-12-53-29.png)

4. ポップアップ表示はスキップします。

![](pasteimage/2021-08-18-12-56-20.png)


## 3.1. 認証画面の作成

このような画面を作っていきます

![](pasteimage/2021-08-18-14-04-34.png)

①カメラ切り替え用のトグルスイッチ
②カメラの映像
③顔認証撮影ボタン


1. 「挿入」をクリックします。

![](pasteimage/2021-08-18-14-06-17.png)

2. 入力から「切り替え」をクリックします。

![](pasteimage/2021-08-18-14-07-10.png)

3. 右ペインのプロパティから「ラベルを表示する」をオフにします。

![](pasteimage/2021-08-18-14-08-08.png)

![](pasteimage/2021-08-18-14-08-32.png)

4. Toggle1 が選択されている状態で、左上のプロパティボックスから「OnChange」を選択します。

![](pasteimage/2021-08-18-14-09-39.png)

5. 関数バーに以下を入力します。

```
If(
    CameraID=0,
    UpdateContext({CameraID:1}),
    UpdateContext({CameraID:0})
)
```

6. 「挿入」＞「メディア」から「カメラ」をクリックします。

![](pasteimage/2021-08-18-14-11-57.png)

7. Camera1 が選択されている状態で、左上のプロパティボックスを「Camera」にセットし、関数バーに以下を入力します。

![](pasteimage/2021-08-18-14-14-26.png)

```
CameraID
```

8. 右ペインで「ストリームレート」を100に変更します。

![](pasteimage/2021-08-18-14-16-27.png)

9. 「挿入」から「ボタン」をクリックします。

![](pasteimage/2021-08-18-14-15-17.png)

10. Button1 が選択されている状態で「アクション」＞「Power Automate」をクリックします。

![](pasteimage/2021-08-18-14-17-27.png)

11. インポートしたフロー「顔認証フロー」を選択します。

![](pasteimage/2021-08-18-14-18-28.png)

12. Button1 が選択されている状態で、左上のプロパティボックスが「OnSelect」になっていることを確認し、関数バーを以下のように書き換えます。

```
Set(
    rtn,
    顔認証フロー.Run(Camera1.Stream)
);
If(
    rtn.rtn="Success",
    Navigate(Screen2),
    Navigate(Screen3)
)
```

## 3.2. 成功画面の作成

このような画面を作ります

![](pasteimage/2021-08-18-14-26-19.png)

1. 「挿入」から「新しい画面」をクリックします。

![](pasteimage/2021-08-18-14-22-20.png)

2. 「成功」をクリックします。

![](pasteimage/2021-08-18-14-22-57.png)

3. 「LblSccessMsg1」をクリックします。

![](pasteimage/2021-08-18-14-24-03.png)

4. 左上のプロパティボックスを「Text」にセットし、関数バーに以下を入力します。

![](pasteimage/2021-08-18-14-28-40.png)

```
Concatenate(
    rtn.visitorname,
    "様、いらっしゃいませ！",
    Char(10),
    "入室を許可します"
)
```

## 3.3. 失敗画面の作成

このような画面を作ります

![](pasteimage/2021-08-18-14-26-47.png)

1. 「挿入」から「新しい画面」をクリックします。

![](pasteimage/2021-08-18-14-22-20.png)

2. 「成功」をクリックします。

![](pasteimage/2021-08-18-14-22-57.png)

3. 「LblSccessMsg2」をクリックします。

![](pasteimage/2021-08-18-14-27-50.png)


4. 左上のプロパティボックスを「Text」にセットし、関数バーを以下のように書き換えます。

![](pasteimage/2021-08-18-14-29-34.png)

```
"顔認証に失敗しました"
```

5. 「iconCheck2」をクリックします。

![](pasteimage/2021-08-18-14-31-47.png)

6. 右ペインのアイコンを「キャンセル」に変更します。

![](pasteimage/2021-08-18-14-30-58.png)

7. 「iconCircle2」をクリックします。

![](pasteimage/2021-08-18-14-32-13.png)

8. 右ペインの色を赤色に変更します。

![](pasteimage/2021-08-18-14-32-55.png)

9. ファイルから保存します。

![](pasteimage/2021-08-18-14-33-42.png)

![](pasteimage/2021-08-18-14-34-09.png)









